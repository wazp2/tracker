<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGS Sınav Takibi - Pomodoro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0f1c;
            color: #d1d5db;
        }
        .container-bg {
            background-color: #1a1e35;
        }
        .purple-gradient {
            background: linear-gradient(90deg, #6c47ff, #8e47ff);
        }
        .box-shadow {
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.2);
        }
        .progress-ring-bg {
            stroke: #2d325a;
        }
        .progress-ring-fg {
            stroke: #8e47ff;
            transition: stroke-dasharray 0.5s linear;
        }
        .btn-shadow {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .btn-base {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-base:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
        }
        .subject-btn.selected {
            background-color: #6c47ff !important;
            border: 2px solid #8e47ff;
        }
        /* New animation added */
        @keyframes pulse-success {
            0% { transform: scale(1); box-shadow: 0 0 0 rgba(142, 71, 255, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 10px rgba(142, 71, 255, 0.8); }
            100% { transform: scale(1); box-shadow: 0 0 0 rgba(142, 71, 255, 0); }
        }
        .animate-pulse-success {
            animation: pulse-success 0.6s ease-out;
        }
    </style>
</head>
<body class="bg-[#0d0f1c] text-gray-300 min-h-screen flex flex-col items-center p-4">

    <!-- Header -->
    <header class="w-full max-w-4xl flex items-center py-4 px-6 mb-8 justify-between">
        <!-- New navigation icon for main page -->
        <a href="https://wazp2.github.io/tracker/" class="purple-gradient p-3 rounded-2xl cursor-pointer hover:opacity-80 transition-opacity btn-shadow">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
        </a>
        
        <div class="flex flex-col items-center flex-grow">
            <h1 class="text-2xl font-bold text-gray-100 text-center">AGS Sınav Takibi</h1>
        </div>
        
        <div class="relative">
            <input type="text" placeholder="Konu ara..." class="bg-[#1a1e35] text-gray-300 rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#8e47ff]">
            <svg xmlns="http://www.w3.org/2d00/svg" class="h-4 w-4 absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        </div>
    </header>

    <!-- Main Content Grid -->
    <main class="w-full max-w-4xl grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Left Column: Timer & Settings -->
        <div class="lg:col-span-2 space-y-6">

            <!-- Pomodoro Timer Card -->
            <div class="container-bg rounded-3xl p-8 box-shadow flex flex-col items-center">
                <h2 class="text-xl font-semibold mb-6 text-gray-200">Pomodoro Timer</h2>

                <!-- Timer Display -->
                <div class="relative w-64 h-64 mb-6">
                    <svg class="w-full h-full transform -rotate-90">
                        <circle class="progress-ring-bg" stroke-width="12" fill="transparent" r="110" cx="128" cy="128" />
                        <circle id="progress-circle" class="progress-ring-fg" stroke-width="12" fill="transparent" r="110" cx="128" cy="128" style="stroke-dasharray: 691.15; stroke-dashoffset: 691.15;"></circle>
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span id="timer-display" class="text-6xl font-bold text-gray-100 mb-2 cursor-pointer">25:00</span>
                        <span id="status-text" class="text-purple-400 font-medium text-lg">Study Session</span>
                    </div>
                </div>

                <!-- Timer Controls -->
                <div class="flex items-center justify-center space-x-4 mb-6">
                    <!-- Başlangıç düğmesi -->
                    <button id="start-btn" class="purple-gradient text-white px-6 py-2 rounded-full font-semibold btn-base btn-shadow flex items-center text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                        </svg>
                        Başla
                    </button>
                    <!-- Duraklat/Devam et düğmesi (zamanlayıcı çalışırken görünecek) -->
                    <button id="pause-resume-btn" class="bg-gray-700 text-gray-300 px-6 py-2 rounded-full font-semibold btn-base btn-shadow hidden flex items-center text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M6 6h4v12H6zM14 6h4v12h-4z" />
                        </svg>
                        Duraklat
                    </button>
                    <!-- Durdurma ve Kaydetme düğmesi (zamanlayıcı çalışırken görünecek) -->
                    <button id="stop-save-btn" class="bg-red-600 text-white px-6 py-2 rounded-full font-semibold btn-base btn-shadow hidden flex items-center text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M6 6h12v12H6z" />
                        </svg>
                        Kaydet
                    </button>
                    <!-- Sıfırlama düğmesi -->
                    <button id="reset-btn" class="bg-gray-700 text-gray-300 px-6 py-2 rounded-full font-semibold btn-base btn-shadow flex items-center text-sm">
                        <svg xmlns="http://www.w3.org/2d00/svg" class="h-5 w-5 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M23 4v6h-6"></path>
                            <path d="M1 20v-6h6"></path>
                            <path d="M3.52 10C4.65 6.55 8.35 4 12 4s7.35 2.55 8.48 6"></path>
                            <path d="M20.48 14c-1.13 3.45-4.83 6-8.48 6s-7.35-2.55-8.48-6"></path>
                        </svg>
                        Sıfırla
                    </button>
                </div>

                <!-- Timer Settings -->
                <div class="w-full max-w-sm flex justify-around text-gray-400 font-medium text-sm">
                    <button id="set-study" class="p-2 rounded-full hover:bg-gray-700">Çalışma</button>
                    <button id="set-break" class="p-2 rounded-full hover:bg-gray-700">Kısa Mola</button>
                    <button id="set-long-break" class="p-2 rounded-full hover:bg-gray-700">Uzun Mola</button>
                </div>
            </div>

            <!-- Study Records Calendar -->
            <div class="container-bg rounded-3xl p-8 box-shadow">
                <h2 class="text-xl font-semibold mb-6 text-gray-200">Çalışma Takibi</h2>
                <!-- Calendar Navigation -->
                <div class="flex justify-between items-center mb-4">
                    <button id="prev-month-btn" class="text-gray-400 hover:text-gray-200 p-2 rounded-full hover:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2d00/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <div class="flex-grow text-center">
                        <span id="current-month-display" class="text-gray-200 text-lg font-semibold"></span>
                    </div>
                    <button id="next-month-btn" class="text-gray-400 hover:text-gray-200 p-2 rounded-full hover:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2d00/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
                <!-- Calendar Grid -->
                <div id="calendar-container" class="grid grid-cols-7 gap-1 text-center">
                    <!-- Calendar days will be rendered here by JS -->
                </div>
            </div>
        </div>

        <!-- Right Column: Stats -->
        <div class="lg:col-span-1 space-y-6">
            <div class="container-bg rounded-3xl p-8 box-shadow purple-gradient">
                <span id="completed-sessions-count" class="text-5xl font-bold text-gray-100">0</span>
                <p class="mt-2 text-gray-200">Tamamlanan Oturumlar</p>
            </div>
            <div class="container-bg rounded-3xl p-8 box-shadow">
                <span id="total-study-time" class="text-5xl font-bold text-gray-100">0</span>
                <p class="mt-2 text-gray-400">Toplam Çalışma Süresi (dakika)</p>
            </div>
            <div class="container-bg rounded-3xl p-8 box-shadow">
                <h3 class="text-xl font-semibold mb-4 text-gray-200">Aylık Analizler</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Toplam Çalışma Süresi</span>
                        <span id="monthly-study-time" class="text-gray-200 font-semibold">0 minutes</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Tamamlanan Oturumlar</span>
                        <span id="monthly-sessions-count" class="text-gray-200 font-semibold">0</span>
                    </div>
                </div>
            </div>
            
            <!-- JSON Save/Load Buttons -->
            <div class="container-bg rounded-3xl p-8 box-shadow flex flex-col space-y-4">
                <h3 class="text-xl font-semibold text-gray-200">Veriyi Yönet</h3>
                <button id="save-json-btn" class="purple-gradient text-white px-6 py-2 rounded-full font-semibold btn-base btn-shadow flex items-center justify-center text-sm">
                    <svg xmlns="http://www.w3.org/2d00/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M13 3h-2c-1.103 0-2 .897-2 2v2H7c-1.103 0-2 .897-2 2v10c0 1.103.897 2 2 2h10c1.103 0 2-.897 2-2V9c0-1.103-.897-2-2-2h-2V5c0-1.103-.897-2-2-2zm-1 14.586l-3.293-3.293-1.414 1.414L12 19.414l5.707-5.707-1.414-1.414L12 14.586zM13 10V5.414l4.586 4.586H13z" />
                    </svg>
                    JSON'a Kaydet
                </button>
                <label for="load-json-file" class="cursor-pointer bg-gray-700 text-gray-300 px-6 py-2 rounded-full font-semibold btn-base btn-shadow flex items-center justify-center text-sm">
                    <svg xmlns="http://www.w3.org/2d00/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z" />
                        <path d="M13 7h-2v4H7v2h4v4h2v-4h4v-2h-4z" />
                    </svg>
                    JSON'dan Yükle
                    <input type="file" id="load-json-file" class="hidden" accept=".json">
                </label>
            </div>
        </div>
    </main>

    <!-- Modal for Starting Session -->
    <div id="start-session-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4">
        <div class="container-bg rounded-3xl p-8 w-full max-w-md box-shadow">
            <h3 id="start-modal-title" class="text-xl font-semibold text-gray-100 mb-4">Yeni Oturum Başlat</h3>
            <p id="start-modal-message" class="text-gray-300 mb-4">Zamanlayıcıyı başlatmadan önce bir konu seçin.</p>
            <div class="mb-4">
                <label for="custom-subject-input" class="block text-gray-400 text-sm font-medium mb-2">Konu Adını Girin</label>
                <input type="text" id="custom-subject-input" placeholder="Konu adımı kendim belirleyeceğim..." class="w-full bg-[#0d0f1c] text-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#8e47ff]" />
                <div id="subject-grid" class="mt-4 grid grid-cols-2 sm:grid-cols-3 gap-4">
                    <button class="subject-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-lg btn-base hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500" data-subject="Sözel Yetenek">Sözel Yetenek</button>
                    <button class="subject-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-lg btn-base hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500" data-subject="Sayısal Yetenek">Sayısal Yetenek</button>
                    <button class="subject-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-lg btn-base hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500" data-subject="Tarih">Tarih</button>
                    <button class="subject-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-lg btn-base hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500" data-subject="Türkiye Coğrafyası">Türkiye Coğrafyası</button>
                    <button class="subject-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-lg btn-base hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500" data-subject="Eğitimin Temelleri ve Türk Milli Eğitim Sistemi">Eğitimin Temelleri ve Türk Milli Eğitim Sistemi</button>
                    <button class="subject-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-lg btn-base hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500" data-subject="Mevzuat">Mevzuat</button>
                    <button class="subject-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-lg btn-base hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500" data-subject="Diğer">Diğer</button>
                </div>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancel-start" class="bg-gray-700 text-gray-300 px-6 py-2 rounded-full font-semibold btn-base">İptal</button>
                <button id="confirm-start" class="purple-gradient text-white px-6 py-2 rounded-full font-semibold btn-base">Oturumu Başlat</button>
            </div>
        </div>
    </div>

    <!-- Modal for Saving Session -->
    <div id="save-session-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4">
        <div class="container-bg rounded-3xl p-8 w-full max-w-md box-shadow">
            <h3 id="save-modal-title" class="text-xl font-semibold text-gray-100 mb-4">Çalışma Oturumunu Kaydet</h3>
            <p id="save-modal-message" class="text-gray-300 mb-4"></p>
            <div class="mb-4">
                <label for="save-subject-input" class="block text-gray-400 text-sm font-medium mb-2">Konu Adını Girin</label>
                <input type="text" id="save-subject-input" placeholder="Konu adımı kendim belirleyeceğim..." class="w-full bg-[#0d0f1c] text-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#8e47ff]" />
                <div id="save-subject-grid" class="mt-4 grid grid-cols-2 sm:grid-cols-3 gap-4">
                    <button class="subject-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-lg btn-base hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500" data-subject="Sözel Yetenek">Sözel Yetenek</button>
                    <button class="subject-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-lg btn-base hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500" data-subject="Sayısal Yetenek">Sayısal Yetenek</button>
                    <button class="subject-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-lg btn-base hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500" data-subject="Tarih">Tarih</button>
                    <button class="subject-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-lg btn-base hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500" data-subject="Türkiye Coğrafyası">Türkiye Coğrafyası</button>
                    <button class="subject-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-lg btn-base hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500" data-subject="Eğitimin Temelleri ve Türk Milli Eğitim Sistemi">Eğitimin Temelleri ve Türk Milli Eğitim Sistemi</button>
                    <button class="subject-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-lg btn-base hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500" data-subject="Mevzuat">Mevzuat</button>
                    <button class="subject-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-lg btn-base hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500" data-subject="Diğer">Diğer</button>
                </div>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancel-save-manual" class="bg-gray-700 text-gray-300 px-6 py-2 rounded-full font-semibold btn-base">İptal</button>
                <button id="confirm-save-manual" class="purple-gradient text-white px-6 py-2 rounded-full font-semibold btn-base">Oturumu Kaydet</button>
            </div>
        </div>
    </div>

    <!-- Modal for Daily Details -->
    <div id="daily-details-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4">
        <div class="container-bg rounded-3xl p-8 w-full max-w-md box-shadow">
            <div class="flex justify-between items-center mb-4">
                <h3 id="daily-details-date" class="text-xl font-semibold text-gray-100"></h3>
                <button id="close-daily-details" class="text-gray-400 hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2d00/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="daily-sessions-list" class="space-y-4">
                <!-- Sessions will be rendered here -->
            </div>
        </div>
    </div>
    
    <!-- Modal for Timer Customization -->
    <div id="customize-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4">
        <div class="container-bg rounded-3xl p-8 w-full max-w-md box-shadow">
            <h3 class="text-xl font-semibold text-gray-100 mb-4">Zamanlayıcıyı Özelleştir</h3>
            <p class="text-gray-300 mb-4">Süreyi dakikalarla belirleyin.</p>
            <div class="mb-4">
                <label for="minutes-input" class="block text-gray-400 text-sm font-medium mb-2">Dakika</label>
                <input type="number" id="minutes-input" min="1" max="120" class="w-full bg-[#0d0f1c] text-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#8e47ff]">
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancel-customize" class="bg-gray-700 text-gray-300 px-6 py-2 rounded-full font-semibold btn-base">İptal</button>
                <button id="confirm-customize" class="purple-gradient text-white px-6 py-2 rounded-full font-semibold btn-base">Kaydet</button>
            </div>
        </div>
    </div>
    <!-- Message Box for Alerts -->
    <div id="message-box" class="fixed bottom-4 right-4 p-4 rounded-xl bg-purple-700 text-white shadow-xl hidden transition-all duration-300 transform scale-95 opacity-0">
      <p id="message-text"></p>
    </div>

    <script>
        window.onload = function() {
            const timerDisplay = document.getElementById('timer-display');
            const statusText = document.getElementById('status-text');
            const startBtn = document.getElementById('start-btn');
            const pauseResumeBtn = document.getElementById('pause-resume-btn');
            const stopSaveBtn = document.getElementById('stop-save-btn');
            const resetBtn = document.getElementById('reset-btn');
            const progressCircle = document.getElementById('progress-circle');
            const calendarContainer = document.getElementById('calendar-container');

            // Modals and their elements
            const startSessionModal = document.getElementById('start-session-modal');
            const customSubjectInput = document.getElementById('custom-subject-input');
            const subjectGrid = document.getElementById('subject-grid');
            const confirmStartBtn = document.getElementById('confirm-start');
            const cancelStartBtn = document.getElementById('cancel-start');

            const saveSessionModal = document.getElementById('save-session-modal');
            const saveModalMessage = document.getElementById('save-modal-message');
            const saveSubjectInput = document.getElementById('save-subject-input');
            const saveSubjectGrid = document.getElementById('save-subject-grid');
            const confirmSaveManualBtn = document.getElementById('confirm-save-manual');
            const cancelSaveManualBtn = document.getElementById('cancel-save-manual');

            const completedSessionsCount = document.getElementById('completed-sessions-count');
            const totalStudyTimeDisplay = document.getElementById('total-study-time');
            const monthlyStudyTime = document.getElementById('monthly-study-time');
            const monthlySessionsCount = document.getElementById('monthly-sessions-count');
            const dailyDetailsModal = document.getElementById('daily-details-modal');
            const dailyDetailsDate = document.getElementById('daily-details-date');
            const dailySessionsList = document.getElementById('daily-sessions-list');
            const closeDailyDetailsBtn = document.getElementById('close-daily-details');
            const customizeModal = document.getElementById('customize-modal');
            const minutesInput = document.getElementById('minutes-input');
            const confirmCustomizeBtn = document.getElementById('confirm-customize');
            const cancelCustomizeBtn = document.getElementById('cancel-customize');
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');
            const currentMonthDisplay = document.getElementById('current-month-display');
            
            // New JSON save/load elements
            const saveJsonBtn = document.getElementById('save-json-btn');
            const loadJsonFileInput = document.getElementById('load-json-file');

            // Audio setup for a relaxing church bell sound
            const bellSynth = new Tone.MembraneSynth({
                pitchDecay: 0.05,
                octaves: 1,
                oscillator: {
                    type: "sine"
                },
                envelope: {
                    attack: 0.001,
                    decay: 1.5,
                    sustain: 0,
                    release: 0.2
                }
            });
            
            const reverb = new Tone.Reverb({
                decay: 5,
                wet: 0.5
            }).toDestination();
            
            const volume = new Tone.Volume(-10).toDestination();

            bellSynth.connect(reverb);
            reverb.connect(volume);

            const appState = {
                timer: null,
                timeRemaining: 0,
                initialDuration: 0,
                isPaused: true,
                isBreak: false,
                studyDuration: parseInt(localStorage.getItem('studyDuration')) || 25 * 60,
                breakDuration: parseInt(localStorage.getItem('breakDuration')) || 5 * 60,
                longBreakDuration: parseInt(localStorage.getItem('longBreakDuration')) || 15 * 60,
                studyRecords: [],
                startTime: 0,
                currentSubject: null, // Unified state for the current session's subject
                isSessionActive: false,
                currentCalendarDate: new Date()
            };

            const CIRCLE_CIRCUMFERENCE = 2 * Math.PI * 110;
            progressCircle.style.strokeDasharray = CIRCLE_CIRCUMFERENCE;
            
            let currentTimerType = 'study'; // 'study', 'break', or 'longBreak'

            const showMessage = (text, duration = 3000) => {
              messageText.textContent = text;
              messageBox.classList.remove('hidden');
              messageBox.classList.add('scale-100', 'opacity-100');
              setTimeout(() => {
                messageBox.classList.remove('scale-100', 'opacity-100');
                messageBox.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                  messageBox.classList.add('hidden');
                }, 300);
              }, duration);
            };

            const updateTimerDisplay = (time) => {
                const minutes = Math.floor(time / 60);
                const seconds = Math.floor(time % 60);
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            };

            const updateProgressCircle = () => {
                const percent = (appState.timeRemaining / appState.initialDuration) * 100;
                const offset = CIRCLE_CIRCUMFERENCE - (percent / 100) * CIRCLE_CIRCUMFERENCE;
                progressCircle.style.strokeDashoffset = offset;
            };

            const playBell = () => {
                // Play a low C note to sound like a deep bell
                const now = Tone.now();
                bellSynth.triggerAttackRelease("C3", "4n", now);
            };

            const updateButtons = (isTimerActive) => {
                if (isTimerActive) {
                    startBtn.classList.add('hidden');
                    pauseResumeBtn.classList.remove('hidden');
                    stopSaveBtn.classList.remove('hidden');
                } else {
                    startBtn.classList.remove('hidden');
                    pauseResumeBtn.classList.add('hidden');
                    stopSaveBtn.classList.add('hidden');
                    pauseResumeBtn.textContent = 'Duraklat';
                }
            };
            
            const startTimer = () => {
                if (!appState.isPaused) return;
                Tone.start(); // Start the audio context on user gesture
                appState.isPaused = false;
                appState.isSessionActive = true;
                
                updateButtons(true);
                pauseResumeBtn.textContent = 'Duraklat';
                pauseResumeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2d00/svg" class="h-5 w-5 mr-1" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h4v12H6zM14 6h4v12h-4z" /></svg>Duraklat`;


                // Set the start time
                appState.startTime = Date.now() - (appState.initialDuration - appState.timeRemaining) * 1000;

                // Play the bell sound when the timer starts
                playBell();

                appState.timer = setInterval(() => {
                    const elapsedTime = Date.now() - appState.startTime;
                    appState.timeRemaining = appState.initialDuration - Math.floor(elapsedTime / 1000);

                    if (appState.timeRemaining <= 0) {
                        clearInterval(appState.timer);
                        appState.isPaused = true;
                        
                        // Play the bell sound when the timer finishes
                        playBell();

                        if (!appState.isBreak) {
                            // Automatically save the session
                            saveStudyRecord(appState.initialDuration, appState.currentSubject);
                            showMessage('Çalışma oturumu tamamlandı ve otomatik olarak kaydedildi!');
                            
                            // Reset for the next break
                            appState.isBreak = false;
                            resetTimer(appState.studyDuration, false);
                        } else {
                            appState.isBreak = false;
                            resetTimer(appState.studyDuration, false);
                        }
                    }
                    updateTimerDisplay(appState.timeRemaining);
                    updateProgressCircle();
                }, 1000);
            };
            
            const pauseTimer = () => {
                clearInterval(appState.timer);
                appState.isPaused = true;
                pauseResumeBtn.textContent = 'Devam Et';
                pauseResumeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2d00/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>Devam Et`;
            };

            const togglePauseResume = () => {
                if (appState.isPaused) {
                    startTimer();
                } else {
                    pauseTimer();
                }
            };
            
            const stopSessionAndSave = () => {
                pauseTimer(); // Duraklat
                const timeStudied = appState.initialDuration - appState.timeRemaining;
                if (timeStudied <= 0) {
                    // Provide a clearer message if the session is too short to save.
                    showMessage('Hata: Oturum süresi çok kısa olduğu için kaydedilemedi. Kaydetmek için en az 1 dakika çalışmalısınız.');
                    resetTimer();
                    return;
                }
                saveSessionModal.classList.remove('hidden');
                saveSessionModal.classList.add('flex');
                saveModalMessage.textContent = `Bu oturumda ${Math.floor(timeStudied / 60)} dakika çalıştınız. Kaydetmek için bir konu seçin.`;
                
                // Prefill the subject from the current session
                if (appState.currentSubject) {
                    saveSubjectInput.value = appState.currentSubject;
                    // Also highlight the corresponding button if it's a pre-defined one
                    document.querySelectorAll('#save-subject-grid .subject-btn').forEach(btn => {
                        if (btn.dataset.subject === appState.currentSubject) {
                            btn.classList.add('selected', 'bg-purple-600', 'ring-2', 'ring-purple-500');
                            btn.classList.remove('bg-gray-700');
                        } else {
                            btn.classList.remove('selected', 'bg-purple-600', 'ring-2', 'ring-purple-500');
                            btn.classList.add('bg-gray-700');
                        }
                    });
                } else {
                    saveSubjectInput.value = '';
                    document.querySelectorAll('#save-subject-grid .subject-btn').forEach(btn => {
                        btn.classList.remove('selected', 'bg-purple-600', 'ring-2', 'ring-purple-500');
                        btn.classList.add('bg-gray-700');
                    });
                }
            };


            const resetTimer = (duration = appState.studyDuration, isBreak = false) => {
                clearInterval(appState.timer);
                appState.isPaused = true;
                appState.isBreak = isBreak;
                appState.timeRemaining = duration;
                appState.initialDuration = duration;
                appState.startTime = 0; // Reset start time
                appState.isSessionActive = false;
                appState.currentSubject = null; // Clear the subject for the new session
                updateTimerDisplay(appState.timeRemaining);
                updateProgressCircle();
                statusText.textContent = isBreak ? 'Mola' : 'Çalışma Oturumu';
                
                updateButtons(false);
                customSubjectInput.value = '';
                document.querySelectorAll('.subject-btn').forEach(btn => btn.classList.remove('selected', 'bg-purple-600', 'ring-2', 'ring-purple-500'));
            };

            const saveStudyRecord = (timeStudied, subjectName) => {
                // FIX: Get local date instead of UTC to fix the one-day-before saving bug
                const today = new Date();
                const year = today.getFullYear();
                const month = (today.getMonth() + 1).toString().padStart(2, '0');
                const day = today.getDate().toString().padStart(2, '0');
                const dateString = `${year}-${month}-${day}`;

                const record = {
                    id: Date.now(), // Unique ID for each session
                    minutes: Math.floor(timeStudied / 60),
                    subject: subjectName,
                    date: dateString, // Store in YYYY-MM-DD format
                };
                
                appState.studyRecords.push(record);
                localStorage.setItem('studyRecords', JSON.stringify(appState.studyRecords));
                
                const dayElement = document.querySelector(`.day-cell[data-date="${record.date}"]`);
                if (dayElement) {
                    dayElement.classList.add('animate-pulse-success');
                    setTimeout(() => {
                        dayElement.classList.remove('animate-pulse-success');
                    }, 600); 
                }

                loadRecordsAndRender();
            };

            const closeModal = (modal) => {
                modal.classList.remove('flex');
                modal.classList.add('hidden');
            };

            const loadRecordsAndRender = () => {
                const records = JSON.parse(localStorage.getItem('studyRecords')) || [];
                appState.studyRecords = records;
                renderCalendar(appState.currentCalendarDate);
                updateAnalytics(appState.studyRecords);
            };
            
            const updateAnalytics = (records) => {
                const totalMinutes = records.reduce((sum, record) => sum + record.minutes, 0);
                const totalSessions = records.length;
                totalStudyTimeDisplay.textContent = totalMinutes;
                completedSessionsCount.textContent = totalSessions;

                const currentMonth = appState.currentCalendarDate.getMonth();
                const currentYear = appState.currentCalendarDate.getFullYear();
                
                const monthlyRecords = records.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.getUTCMonth() === currentMonth && recordDate.getUTCFullYear() === currentYear;
                });
                
                const monthlyMinutes = monthlyRecords.reduce((sum, record) => sum + record.minutes, 0);
                monthlyStudyTime.textContent = `${monthlyMinutes} dakika`;
                monthlySessionsCount.textContent = monthlyRecords.length;
            };

            const renderCalendar = (date) => {
                calendarContainer.innerHTML = '';
                
                const currentMonth = date.getMonth();
                const currentYear = date.getFullYear();

                const today = new Date();
                const todayMonth = today.getMonth();
                const todayYear = today.getFullYear();

                currentMonthDisplay.textContent = `${date.toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' })}`;

                const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

                const monthlyRecords = appState.studyRecords.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.getUTCMonth() === currentMonth && recordDate.getUTCFullYear() === currentYear;
                });

                const dailyStudyMap = monthlyRecords.reduce((acc, record) => {
                    const day = new Date(record.date).getUTCDate();
                    if (!acc[day]) acc[day] = { minutes: 0, sessions: [] };
                    acc[day].minutes += record.minutes;
                    acc[day].sessions.push(record);
                    return acc;
                }, {});

                const daysOfWeek = ['Paz', 'Pzt', 'Sal', 'Çar', 'Per', 'Cum', 'Cmt'];
                daysOfWeek.forEach(day => {
                    const el = document.createElement('div');
                    el.className = 'text-xs font-semibold text-gray-500';
                    el.textContent = day;
                    calendarContainer.appendChild(el);
                });

                for (let i = 0; i < firstDayOfMonth; i++) {
                    const emptyDiv = document.createElement('div');
                    calendarContainer.appendChild(emptyDiv);
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'day-cell flex flex-col items-center justify-center p-1 rounded-lg transition-colors cursor-pointer hover:bg-gray-700';
                    dayDiv.dataset.day = i;
                    dayDiv.dataset.date = `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}-${i.toString().padStart(2, '0')}`;

                    const dailyData = dailyStudyMap[i] || { minutes: 0, sessions: [] };
                    const studyMinutes = dailyData.minutes;
                    
                    if (i === today.getDate() && currentMonth === todayMonth && currentYear === todayYear) {
                        dayDiv.classList.add('ring-2', 'ring-purple-400');
                    }
                    
                    if (studyMinutes > 0) {
                        let bgColor;
                        if (studyMinutes < 30) bgColor = 'bg-purple-900';
                        else if (studyMinutes < 60) bgColor = 'bg-purple-800';
                        else if (studyMinutes < 120) bgColor = 'bg-purple-700';
                        else bgColor = 'bg-purple-600';
                        dayDiv.classList.add(bgColor);
                    }
                    
                    const dayNumber = document.createElement('span');
                    dayNumber.className = 'text-gray-200 font-bold text-sm';
                    dayNumber.textContent = i;
                    dayDiv.appendChild(dayNumber);

                    if (studyMinutes > 0) {
                        const studyTime = document.createElement('span');
                        studyTime.className = 'text-xs text-gray-400 mt-1';
                        studyTime.textContent = `${studyMinutes} dk`;
                        dayDiv.appendChild(studyTime);
                    }

                    dayDiv.addEventListener('click', () => {
                        showDailyDetails(dayDiv.dataset.date, dailyData.sessions);
                    });

                    calendarContainer.appendChild(dayDiv);
                }
            };

            const showDailyDetails = (dateString, sessions) => {
                dailyDetailsDate.textContent = new Date(dateString).toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
                dailySessionsList.innerHTML = '';
                if (sessions.length === 0) {
                    dailySessionsList.innerHTML = '<p class="text-gray-400">Bu günde kaydedilmiş oturum bulunmuyor.</p>';
                } else {
                    sessions.forEach(session => {
                        const sessionItem = document.createElement('div');
                        sessionItem.className = 'bg-gray-700 p-4 rounded-xl flex justify-between items-center';
                        sessionItem.innerHTML = `
                            <div>
                                <h4 class="font-semibold text-gray-200">${session.subject}</h4>
                                <p class="text-sm text-gray-400">${session.minutes} dakika</p>
                            </div>
                        `;
                        dailySessionsList.appendChild(sessionItem);
                    });
                }
                dailyDetailsModal.classList.remove('hidden');
                dailyDetailsModal.classList.add('flex');
            };

            // Event Listeners for new calendar navigation
            prevMonthBtn.addEventListener('click', () => {
                const prevMonth = new Date(appState.currentCalendarDate.getFullYear(), appState.currentCalendarDate.getMonth() - 1, 1);
                appState.currentCalendarDate = prevMonth;
                loadRecordsAndRender();
            });

            nextMonthBtn.addEventListener('click', () => {
                const nextMonth = new Date(appState.currentCalendarDate.getFullYear(), appState.currentCalendarDate.getMonth() + 1, 1);
                appState.currentCalendarDate = nextMonth;
                loadRecordsAndRender();
            });

            // --- JSON Save/Load Logic ---
            const saveToJSON = () => {
                const jsonData = JSON.stringify(appState.studyRecords, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ags_takip_verileri.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showMessage('Verileriniz JSON dosyası olarak kaydedildi.');
            };

            const loadFromJSON = (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const loadedData = JSON.parse(e.target.result);
                        if (Array.isArray(loadedData)) {
                            appState.studyRecords = loadedData;
                            localStorage.setItem('studyRecords', JSON.stringify(appState.studyRecords));
                            loadRecordsAndRender();
                            showMessage('Veriler başarıyla yüklendi.');
                        } else {
                            showMessage('Hata: Seçilen dosya geçerli bir veri formatı içermiyor.');
                        }
                    } catch (error) {
                        console.error('JSON dosyasını ayrıştırma hatası:', error);
                        showMessage('Hata: Dosya okunamadı veya bozuk.');
                    }
                };
                reader.readAsText(file);
            };

            // Initial setup
            resetTimer();
            loadRecordsAndRender();

            // Load last selected subject on page load
            const lastSubject = localStorage.getItem('lastSelectedSubject');
            if (lastSubject) {
                const selectedBtn = document.querySelector(`.subject-btn[data-subject="${lastSubject}"]`);
                if (selectedBtn) {
                    selectedBtn.classList.add('selected', 'bg-purple-600', 'ring-2', 'ring-purple-500');
                    selectedBtn.classList.remove('bg-gray-700');
                }
                customSubjectInput.value = lastSubject;
            }

            // All other event listeners from original code
            startBtn.addEventListener('click', () => {
                startSessionModal.classList.remove('hidden');
                startSessionModal.classList.add('flex');
                
                // Set the input value to the remembered subject, if any
                const lastSelectedSubject = localStorage.getItem('lastSelectedSubject');
                if (lastSelectedSubject) {
                    customSubjectInput.value = lastSelectedSubject;
                    appState.currentSubject = lastSelectedSubject;
                    const selectedBtn = document.querySelector(`#subject-grid .subject-btn[data-subject="${lastSelectedSubject}"]`);
                    if (selectedBtn) {
                        selectedBtn.classList.add('selected', 'bg-purple-600', 'ring-2', 'ring-purple-500');
                        selectedBtn.classList.remove('bg-gray-700');
                    }
                } else {
                    customSubjectInput.value = '';
                    appState.currentSubject = null;
                }
            });

            pauseResumeBtn.addEventListener('click', togglePauseResume);
            stopSaveBtn.addEventListener('click', stopSessionAndSave);
            resetBtn.addEventListener('click', () => resetTimer());
            cancelStartBtn.addEventListener('click', () => closeModal(startSessionModal));
            cancelSaveManualBtn.addEventListener('click', () => closeModal(saveSessionModal));

            // Start Session Logic
            confirmStartBtn.addEventListener('click', () => {
                const selectedSubject = customSubjectInput.value || appState.currentSubject;
                if (!selectedSubject) {
                    showMessage('Lütfen bir konu seçin veya adını girin.');
                    return;
                }
                localStorage.setItem('lastSelectedSubject', selectedSubject);
                resetTimer(appState.studyDuration, false);
                appState.currentSubject = selectedSubject;
                startTimer();
                closeModal(startSessionModal);
            });

            // Save Session Logic (after manual stop)
            confirmSaveManualBtn.addEventListener('click', () => {
                const timeStudied = appState.initialDuration - appState.timeRemaining;
                const selectedSubject = saveSubjectInput.value || appState.currentSubject;

                if (timeStudied > 0) {
                    saveStudyRecord(timeStudied, selectedSubject);
                    showMessage('Oturum başarıyla kaydedildi!');
                }
                localStorage.setItem('lastSelectedSubject', selectedSubject);
                closeModal(saveSessionModal);
                resetTimer();
            });

            // Subject button and input logic for the START modal
            subjectGrid.querySelectorAll('.subject-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    subjectGrid.querySelectorAll('.subject-btn').forEach(b => {
                        b.classList.remove('selected', 'bg-purple-600', 'ring-2', 'ring-purple-500');
                        b.classList.add('bg-gray-700');
                    });
                    btn.classList.add('selected', 'bg-purple-600', 'ring-2', 'ring-purple-500');
                    btn.classList.remove('bg-gray-700');
                    appState.currentSubject = btn.dataset.subject;
                    customSubjectInput.value = btn.dataset.subject;
                    localStorage.setItem('lastSelectedSubject', btn.dataset.subject);
                });
            });

            customSubjectInput.addEventListener('input', () => {
                if (customSubjectInput.value) {
                    subjectGrid.querySelectorAll('.subject-btn').forEach(btn => {
                        btn.classList.remove('selected', 'bg-purple-600', 'ring-2', 'ring-purple-500');
                        btn.classList.add('bg-gray-700');
                    });
                    appState.currentSubject = customSubjectInput.value;
                    localStorage.setItem('lastSelectedSubject', customSubjectInput.value);
                }
            });

            // Subject button and input logic for the SAVE modal
            saveSubjectGrid.querySelectorAll('.subject-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    saveSubjectGrid.querySelectorAll('.subject-btn').forEach(b => {
                        b.classList.remove('selected', 'bg-purple-600', 'ring-2', 'ring-purple-500');
                        b.classList.add('bg-gray-700');
                    });
                    btn.classList.add('selected', 'bg-purple-600', 'ring-2', 'ring-purple-500');
                    btn.classList.remove('bg-gray-700');
                    appState.currentSubject = btn.dataset.subject;
                    saveSubjectInput.value = btn.dataset.subject;
                    localStorage.setItem('lastSelectedSubject', btn.dataset.subject);
                });
            });

            saveSubjectInput.addEventListener('input', () => {
                if (saveSubjectInput.value) {
                    saveSubjectGrid.querySelectorAll('.subject-btn').forEach(btn => {
                        btn.classList.remove('selected', 'bg-purple-600', 'ring-2', 'ring-purple-500');
                        btn.classList.add('bg-gray-700');
                    });
                    appState.currentSubject = saveSubjectInput.value;
                    localStorage.setItem('lastSelectedSubject', saveSubjectInput.value);
                }
            });

            closeDailyDetailsBtn.addEventListener('click', () => {
                dailyDetailsModal.classList.remove('flex');
                dailyDetailsModal.classList.add('hidden');
            });
            
            // Timer settings buttons
            document.getElementById('set-study').addEventListener('click', () => {
                resetTimer(appState.studyDuration, false);
                currentTimerType = 'study';
            });
            document.getElementById('set-break').addEventListener('click', () => {
                resetTimer(appState.breakDuration, true);
                currentTimerType = 'break';
            });
            document.getElementById('set-long-break').addEventListener('click', () => {
                resetTimer(appState.longBreakDuration, true);
                currentTimerType = 'longBreak';
            });
            
            // Timer customization modal
            timerDisplay.addEventListener('click', () => {
                minutesInput.value = Math.floor(appState.initialDuration / 60);
                customizeModal.classList.remove('hidden');
                customizeModal.classList.add('flex');
            });

            cancelCustomizeBtn.addEventListener('click', () => {
                customizeModal.classList.remove('flex');
                customizeModal.classList.add('hidden');
            });

            confirmCustomizeBtn.addEventListener('click', () => {
                const newDuration = parseInt(minutesInput.value, 10) * 60;
                if (newDuration > 0) {
                    if (currentTimerType === 'study') {
                        appState.studyDuration = newDuration;
                        localStorage.setItem('studyDuration', newDuration);
                    } else if (currentTimerType === 'break') {
                        appState.breakDuration = newDuration;
                        localStorage.setItem('breakDuration', newDuration);
                    } else if (currentTimerType === 'longBreak') {
                        appState.longBreakDuration = newDuration;
                        localStorage.setItem('longBreakDuration', newDuration);
                    }
                    resetTimer(newDuration, appState.isBreak);
                } else {
                    showMessage('Lütfen geçerli bir süre girin.');
                }
                customizeModal.classList.remove('flex');
                customizeModal.classList.add('hidden');
            });

            // New JSON event listeners
            saveJsonBtn.addEventListener('click', saveToJSON);
            loadJsonFileInput.addEventListener('change', loadFromJSON);
        };
    </script>
</body>
</html>
