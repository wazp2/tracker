<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGS Sınav Takibi - Pomodoro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0f1c;
            color: #d1d5db;
        }
        .container-bg {
            background-color: #1a1e35;
        }
        .purple-gradient {
            background: linear-gradient(90deg, #6c47ff, #8e47ff);
        }
        .box-shadow {
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.2);
        }
        .progress-ring-bg {
            stroke: #2d325a;
        }
        .progress-ring-fg {
            stroke: #8e47ff;
            transition: stroke-dasharray 0.5s linear;
        }
        .btn-shadow {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .btn-base {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-base:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
        }
        .subject-btn.selected {
            background-color: #6c47ff !important;
            border: 2px solid #8e47ff;
        }
        /* New animation added */
        @keyframes pulse-success {
            0% { transform: scale(1); box-shadow: 0 0 0 rgba(142, 71, 255, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 10px rgba(142, 71, 255, 0.8); }
            100% { transform: scale(1); box-shadow: 0 0 0 rgba(142, 71, 255, 0); }
        }
        .animate-pulse-success {
            animation: pulse-success 0.6s ease-out;
        }
    </style>
</head>
<body class="bg-[#0d0f1c] text-gray-300 min-h-screen flex flex-col items-center p-4">

    <!-- Header -->
    <header class="w-full max-w-4xl flex items-center py-4 px-6 mb-8 justify-between">
        <!-- New navigation icon for main page -->
        <a href="/" class="purple-gradient p-3 rounded-2xl cursor-pointer hover:opacity-80 transition-opacity btn-shadow">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
        </a>
        
        <div class="flex flex-col items-center flex-grow">
            <h1 class="text-2xl font-bold text-gray-100 text-center">AGS Sınav Takibi</h1>
        </div>
        
        <div class="relative">
            <input type="text" placeholder="Konu ara..." class="bg-[#1a1e35] text-gray-300 rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#8e47ff]">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        </div>
    </header>

    <!-- Main Content Grid -->
    <main class="w-full max-w-4xl grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Left Column: Timer & Settings -->
        <div class="lg:col-span-2 space-y-6">

            <!-- Pomodoro Timer Card -->
            <div class="container-bg rounded-3xl p-8 box-shadow flex flex-col items-center">
                <h2 class="text-xl font-semibold mb-6 text-gray-200">Pomodoro Timer</h2>

                <!-- Timer Display -->
                <div class="relative w-64 h-64 mb-6">
                    <svg class="w-full h-full transform -rotate-90">
                        <circle class="progress-ring-bg" stroke-width="12" fill="transparent" r="110" cx="128" cy="128" />
                        <circle id="progress-circle" class="progress-ring-fg" stroke-width="12" fill="transparent" r="110" cx="128" cy="128" style="stroke-dasharray: 691.15; stroke-dashoffset: 691.15;"></circle>
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span id="timer-display" class="text-6xl font-bold text-gray-100 mb-2 cursor-pointer">25:00</span>
                        <span id="status-text" class="text-purple-400 font-medium text-lg">Study Session</span>
                    </div>
                </div>

                <!-- Timer Controls -->
                <div class="flex items-center justify-center space-x-4 mb-6">
                    <!-- Başlangıç düğmesi -->
                    <button id="start-btn" class="purple-gradient text-white px-6 py-2 rounded-full font-semibold btn-base btn-shadow flex items-center text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                        </svg>
                        Başla
                    </button>
                    <!-- Duraklat/Devam et düğmesi (zamanlayıcı çalışırken görünecek) -->
                    <button id="pause-resume-btn" class="bg-gray-700 text-gray-300 px-6 py-2 rounded-full font-semibold btn-base btn-shadow hidden flex items-center text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M6 6h4v12H6zM14 6h4v12h-4z" />
                        </svg>
                        Duraklat
                    </button>
                    <!-- Durdurma ve Kaydetme düğmesi (zamanlayıcı çalışırken görünecek) -->
                    <button id="stop-save-btn" class="bg-red-600 text-white px-6 py-2 rounded-full font-semibold btn-base btn-shadow hidden flex items-center text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M6 6h12v12H6z" />
                        </svg>
                        Kaydet
                    </button>
                    <!-- Sıfırlama düğmesi -->
                    <button id="reset-btn" class="bg-gray-700 text-gray-300 px-6 py-2 rounded-full font-semibold btn-base btn-shadow flex items-center text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M23 4v6h-6"></path>
                            <path d="M1 20v-6h6"></path>
                            <path d="M3.52 10C4.65 6.55 8.35 4 12 4s7.35 2.55 8.48 6"></path>
                            <path d="M20.48 14c-1.13 3.45-4.83 6-8.48 6s-7.35-2.55-8.48-6"></path>
                        </svg>
                        Sıfırla
                    </button>
                </div>

                <!-- Timer Settings -->
                <div class="w-full max-w-sm flex justify-around text-gray-400 font-medium text-sm">
                    <button id="set-study" class="p-2 rounded-full hover:bg-gray-700">Çalışma</button>
                    <button id="set-break" class="p-2 rounded-full hover:bg-gray-700">Kısa Mola</button>
                    <button id="set-long-break" class="p-2 rounded-full hover:bg-gray-700">Uzun Mola</button>
                </div>
            </div>

            <!-- Study Records Calendar -->
            <div class="container-bg rounded-3xl p-8 box-shadow">
                <h2 class="text-xl font-semibold mb-6 text-gray-200">Çalışma Takibi</h2>
                <div id="calendar-container" class="grid grid-cols-7 gap-1 text-center">
                    <!-- Calendar days will be rendered here by JS -->
                </div>
            </div>
        </div>

        <!-- Right Column: Stats -->
        <div class="lg:col-span-1 space-y-6">
            <div class="container-bg rounded-3xl p-8 box-shadow purple-gradient">
                <span id="completed-sessions-count" class="text-5xl font-bold text-gray-100">0</span>
                <p class="mt-2 text-gray-200">Tamamlanan Oturumlar</p>
            </div>
            <div class="container-bg rounded-3xl p-8 box-shadow">
                <span id="total-study-time" class="text-5xl font-bold text-gray-100">0</span>
                <p class="mt-2 text-gray-400">Toplam Çalışma Süresi (dakika)</p>
            </div>
            <div class="container-bg rounded-3xl p-8 box-shadow">
                <h3 class="text-xl font-semibold mb-4 text-gray-200">Aylık Analizler</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Toplam Çalışma Süresi</span>
                        <span id="monthly-study-time" class="text-gray-200 font-semibold">0 minutes</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Tamamlanan Oturumlar</span>
                        <span id="monthly-sessions-count" class="text-gray-200 font-semibold">0</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal for Saving Study Session -->
    <div id="save-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4">
        <div class="container-bg rounded-3xl p-8 w-full max-w-md box-shadow">
            <h3 id="modal-title" class="text-xl font-semibold text-gray-100 mb-4">Yeni Oturum Başlat</h3>
            <p id="modal-message" class="text-gray-300 mb-4">Zamanlayıcıyı başlatmadan önce bir konu seçin.</p>
            <div class="mb-4">
                <label for="custom-subject-input" class="block text-gray-400 text-sm font-medium mb-2">Konu Adını Girin</label>
                <input type="text" id="custom-subject-input" placeholder="Konu adımı kendim belirleyeceğim..." class="w-full bg-[#0d0f1c] text-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#8e47ff]" />
                <div id="subject-grid" class="mt-4 grid grid-cols-2 sm:grid-cols-3 gap-4">
                    <button class="subject-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-lg btn-base hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500" data-subject="Sözel Yetenek">Sözel Yetenek</button>
                    <button class="subject-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-lg btn-base hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500" data-subject="Sayısal Yetenek">Sayısal Yetenek</button>
                    <button class="subject-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-lg btn-base hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500" data-subject="Tarih">Tarih</button>
                    <button class="subject-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-lg btn-base hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500" data-subject="Türkiye Coğrafyası">Türkiye Coğrafyası</button>
                    <button class="subject-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-lg btn-base hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500" data-subject="Eğitimin Temelleri ve Türk Milli Eğitim Sistemi">Eğitimin Temelleri ve Türk Milli Eğitim Sistemi</button>
                    <button class="subject-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-lg btn-base hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500" data-subject="Mevzuat">Mevzuat</button>
                    <button class="subject-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-lg btn-base hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500" data-subject="Diğer">Diğer</button>
                </div>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancel-save" class="bg-gray-700 text-gray-300 px-6 py-2 rounded-full font-semibold btn-base">İptal</button>
                <button id="confirm-save" class="purple-gradient text-white px-6 py-2 rounded-full font-semibold btn-base">Oturumu Başlat</button>
            </div>
        </div>
    </div>

    <!-- Modal for Daily Details -->
    <div id="daily-details-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4">
        <div class="container-bg rounded-3xl p-8 w-full max-w-md box-shadow">
            <div class="flex justify-between items-center mb-4">
                <h3 id="daily-details-date" class="text-xl font-semibold text-gray-100"></h3>
                <button id="close-daily-details" class="text-gray-400 hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="daily-sessions-list" class="space-y-4">
                <!-- Sessions will be rendered here -->
            </div>
        </div>
    </div>
    
    <!-- Modal for Timer Customization -->
    <div id="customize-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4">
        <div class="container-bg rounded-3xl p-8 w-full max-w-md box-shadow">
            <h3 class="text-xl font-semibold text-gray-100 mb-4">Zamanlayıcıyı Özelleştir</h3>
            <p class="text-gray-300 mb-4">Süreyi dakikalarla belirleyin.</p>
            <div class="mb-4">
                <label for="minutes-input" class="block text-gray-400 text-sm font-medium mb-2">Dakika</label>
                <input type="number" id="minutes-input" min="1" max="120" class="w-full bg-[#0d0f1c] text-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#8e47ff]">
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancel-customize" class="bg-gray-700 text-gray-300 px-6 py-2 rounded-full font-semibold btn-base">İptal</button>
                <button id="confirm-customize" class="purple-gradient text-white px-6 py-2 rounded-full font-semibold btn-base">Kaydet</button>
            </div>
        </div>
    </div>
    <!-- Message Box for Alerts -->
    <div id="message-box" class="fixed bottom-4 right-4 p-4 rounded-xl bg-purple-700 text-white shadow-xl hidden transition-all duration-300 transform scale-95 opacity-0">
      <p id="message-text"></p>
    </div>

    <script>
        window.onload = function() {
            const timerDisplay = document.getElementById('timer-display');
            const statusText = document.getElementById('status-text');
            const startBtn = document.getElementById('start-btn');
            const pauseResumeBtn = document.getElementById('pause-resume-btn');
            const stopSaveBtn = document.getElementById('stop-save-btn');
            const resetBtn = document.getElementById('reset-btn');
            const progressCircle = document.getElementById('progress-circle');
            const calendarContainer = document.getElementById('calendar-container');
            const saveModal = document.getElementById('save-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const subjectGrid = document.getElementById('subject-grid');
            const customSubjectInput = document.getElementById('custom-subject-input');
            const startSessionBtn = document.getElementById('confirm-save');
            const cancelSaveBtn = document.getElementById('cancel-save');
            const completedSessionsCount = document.getElementById('completed-sessions-count');
            const totalStudyTimeDisplay = document.getElementById('total-study-time');
            const monthlyStudyTime = document.getElementById('monthly-study-time');
            const monthlySessionsCount = document.getElementById('monthly-sessions-count');
            const dailyDetailsModal = document.getElementById('daily-details-modal');
            const dailyDetailsDate = document.getElementById('daily-details-date');
            const dailySessionsList = document.getElementById('daily-sessions-list');
            const closeDailyDetailsBtn = document.getElementById('close-daily-details');
            const customizeModal = document.getElementById('customize-modal');
            const minutesInput = document.getElementById('minutes-input');
            const confirmCustomizeBtn = document.getElementById('confirm-customize');
            const cancelCustomizeBtn = document.getElementById('cancel-customize');
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            
            // Audio setup for a relaxing church bell sound
            const bellSynth = new Tone.MembraneSynth({
                pitchDecay: 0.05,
                octaves: 1,
                oscillator: {
                    type: "sine"
                },
                envelope: {
                    attack: 0.001,
                    decay: 1.5,
                    sustain: 0,
                    release: 0.2
                }
            });
            
            const reverb = new Tone.Reverb({
                decay: 5,
                wet: 0.5
            }).toDestination();
            
            const volume = new Tone.Volume(-10).toDestination();

            bellSynth.connect(reverb);
            reverb.connect(volume);

            const appState = {
                timer: null,
                timeRemaining: 0,
                initialDuration: 0,
                isPaused: true,
                isBreak: false,
                studyDuration: parseInt(localStorage.getItem('studyDuration')) || 25 * 60,
                breakDuration: parseInt(localStorage.getItem('breakDuration')) || 5 * 60,
                longBreakDuration: parseInt(localStorage.getItem('longBreakDuration')) || 15 * 60,
                studyRecords: [],
                startTime: 0,
                selectedSubject: null, // Store selected subject from the grid
                isSessionActive: false
            };

            const CIRCLE_CIRCUMFERENCE = 2 * Math.PI * 110;
            progressCircle.style.strokeDasharray = CIRCLE_CIRCUMFERENCE;
            
            let currentTimerType = 'study'; // 'study', 'break', or 'longBreak'

            const showMessage = (text, duration = 3000) => {
              messageText.textContent = text;
              messageBox.classList.remove('hidden');
              messageBox.classList.add('scale-100', 'opacity-100');
              setTimeout(() => {
                messageBox.classList.remove('scale-100', 'opacity-100');
                messageBox.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                  messageBox.classList.add('hidden');
                }, 300);
              }, duration);
            };

            const updateTimerDisplay = (time) => {
                const minutes = Math.floor(time / 60);
                const seconds = Math.floor(time % 60);
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            };

            const updateProgressCircle = () => {
                const percent = (appState.timeRemaining / appState.initialDuration) * 100;
                const offset = CIRCLE_CIRCUMFERENCE - (percent / 100) * CIRCLE_CIRCUMFERENCE;
                progressCircle.style.strokeDashoffset = offset;
            };

            const playBell = () => {
                // Play a low C note to sound like a deep bell
                const now = Tone.now();
                bellSynth.triggerAttackRelease("C3", "4n", now);
            };

            const updateButtons = (isTimerActive) => {
                if (isTimerActive) {
                    startBtn.classList.add('hidden');
                    pauseResumeBtn.classList.remove('hidden');
                    stopSaveBtn.classList.remove('hidden');
                } else {
                    startBtn.classList.remove('hidden');
                    pauseResumeBtn.classList.add('hidden');
                    stopSaveBtn.classList.add('hidden');
                    pauseResumeBtn.textContent = 'Duraklat';
                }
            };
            
            const startTimer = () => {
                if (!appState.isPaused) return;
                Tone.start(); // Start the audio context on user gesture
                appState.isPaused = false;
                appState.isSessionActive = true;
                
                updateButtons(true);
                pauseResumeBtn.textContent = 'Duraklat';
                pauseResumeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h4v12H6zM14 6h4v12h-4z" /></svg>Duraklat`;


                // Set the start time
                appState.startTime = Date.now() - (appState.initialDuration - appState.timeRemaining) * 1000;

                // Play the bell sound when the timer starts
                playBell();

                appState.timer = setInterval(() => {
                    const elapsedTime = Date.now() - appState.startTime;
                    appState.timeRemaining = appState.initialDuration - Math.floor(elapsedTime / 1000);

                    if (appState.timeRemaining <= 0) {
                        clearInterval(appState.timer);
                        appState.isPaused = true;
                        
                        // Play the bell sound when the timer finishes
                        playBell();

                        if (!appState.isBreak) {
                            // Automatically save the session
                            saveStudyRecord(appState.initialDuration);
                            showMessage('Çalışma oturumu tamamlandı ve otomatik olarak kaydedildi!');
                            
                            // Reset for the next break
                            appState.isBreak = false;
                            resetTimer(appState.studyDuration, false);
                        } else {
                            appState.isBreak = false;
                            resetTimer(appState.studyDuration, false);
                        }
                    }
                    updateTimerDisplay(appState.timeRemaining);
                    updateProgressCircle();
                }, 1000);
            };
            
            const pauseTimer = () => {
                clearInterval(appState.timer);
                appState.isPaused = true;
                pauseResumeBtn.textContent = 'Devam Et';
                pauseResumeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>Devam Et`;
            };

            const togglePauseResume = () => {
                if (appState.isPaused) {
                    startTimer();
                } else {
                    pauseTimer();
                }
            };
            
            const stopSessionAndSave = () => {
                pauseTimer(); // Duraklat
                const timeStudied = appState.initialDuration - appState.timeRemaining;
                if (timeStudied <= 0) {
                    showMessage('Oturumun kaydedilmesi için 0 dakikadan uzun olması gerekir.');
                    resetTimer();
                    return;
                }
                showSaveModal(true); // Kayıt modalını göster
            };


            const resetTimer = (duration = appState.studyDuration, isBreak = false) => {
                clearInterval(appState.timer);
                appState.isPaused = true;
                appState.isBreak = isBreak;
                appState.timeRemaining = duration;
                appState.initialDuration = duration;
                appState.startTime = 0; // Reset start time
                appState.isSessionActive = false;
                updateTimerDisplay(appState.timeRemaining);
                updateProgressCircle();
                statusText.textContent = isBreak ? 'Mola' : 'Çalışma Oturumu';
                
                updateButtons(false);
                customSubjectInput.value = '';
                appState.selectedSubject = null;
                document.querySelectorAll('.subject-btn').forEach(btn => btn.classList.remove('selected', 'bg-purple-600', 'ring-2', 'ring-purple-500'));
            };

            const showSaveModal = (isManualSave) => {
                modalTitle.textContent = isManualSave ? 'Çalışma Oturumunu Kaydet' : 'Yeni Oturum Başlat';
                modalMessage.textContent = isManualSave 
                    ? `Bu oturumda ${Math.floor((appState.initialDuration - appState.timeRemaining) / 60)} dakika çalıştınız. Kaydetmek için bir konu seçin.`
                    : 'Zamanlayıcıyı başlatmadan önce bir konu seçin.';
                startSessionBtn.textContent = isManualSave ? 'Oturumu Kaydet' : 'Oturumu Başlat';
                
                saveModal.classList.remove('hidden');
                saveModal.classList.add('flex');
            };

            const saveStudyRecord = (timeStudied) => {
                let subjectName;
                if (customSubjectInput.value) {
                    subjectName = customSubjectInput.value;
                } else if (appState.selectedSubject) {
                    subjectName = appState.selectedSubject;
                } else {
                    subjectName = 'Genel';
                }

                const today = new Date();
                const year = today.getFullYear();
                const month = (today.getMonth() + 1).toString().padStart(2, '0');
                const day = today.getDate().toString().padStart(2, '0');
                const date = `${year}-${month}-${day}`;
                
                const record = {
                    minutes: Math.floor(timeStudied / 60),
                    subject: subjectName,
                    date: date
                };

                appState.studyRecords.push(record);
                localStorage.setItem('studyRecords', JSON.stringify(appState.studyRecords));
                
                // Takvimdeki ilgili günün animasyonunu tetikle
                const dayElement = document.querySelector(`.day-cell[data-day="${today.getDate()}"]`);
                if (dayElement) {
                    dayElement.classList.add('animate-pulse-success');
                    setTimeout(() => {
                        dayElement.classList.remove('animate-pulse-success');
                    }, 600); // Animasyon süresi 0.6s
                }

                loadRecordsAndRender();
            };

            const closeModal = () => {
                saveModal.classList.remove('flex');
                saveModal.classList.add('hidden');
            };

            const loadRecordsAndRender = () => {
                const records = JSON.parse(localStorage.getItem('studyRecords')) || [];
                appState.studyRecords = records;
                renderCalendar(records);
                updateAnalytics(records);
            };
            
            const updateAnalytics = (records) => {
                const totalMinutes = records.reduce((sum, record) => sum + record.minutes, 0);
                const totalSessions = records.length;
                totalStudyTimeDisplay.textContent = totalMinutes;
                completedSessionsCount.textContent = totalSessions;

                const today = new Date();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                
                const monthlyRecords = records.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.getMonth() === currentMonth && recordDate.getFullYear() === currentYear;
                });
                
                const monthlyMinutes = monthlyRecords.reduce((sum, record) => sum + record.minutes, 0);
                monthlyStudyTime.textContent = `${monthlyMinutes} dakika`;
                monthlySessionsCount.textContent = monthlyRecords.length;
            };

            const renderCalendar = (records) => {
                calendarContainer.innerHTML = '';
                const today = new Date();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

                const dailyStudyMap = records.reduce((acc, record) => {
                    const date = new Date(record.date);
                    const day = date.getDate();
                    acc[day] = (acc[day] || 0) + record.minutes;
                    return acc;
                }, {});

                const daysOfWeek = ['Paz', 'Pzt', 'Sal', 'Çar', 'Per', 'Cum', 'Cmt'];
                daysOfWeek.forEach(day => {
                    const el = document.createElement('div');
                    el.className = 'text-xs font-semibold text-gray-500';
                    el.textContent = day;
                    calendarContainer.appendChild(el);
                });

                for (let i = 0; i < firstDayOfMonth; i++) {
                    const emptyDiv = document.createElement('div');
                    calendarContainer.appendChild(emptyDiv);
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'day-cell flex flex-col items-center justify-center p-1 rounded-lg transition-colors cursor-pointer hover:bg-gray-700';
                    dayDiv.dataset.day = i;

                    const studyMinutes = dailyStudyMap[i] || 0;
                    
                    if (i === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear()) {
                        dayDiv.classList.add('ring-2', 'ring-purple-400');
                    }
                    
                    if (studyMinutes > 0) {
                        let bgColor;
                        if (studyMinutes < 30) bgColor = 'bg-purple-900';
                        else if (studyMinutes < 60) bgColor = 'bg-purple-800';
                        else if (studyMinutes < 120) bgColor = 'bg-purple-700';
                        else bgColor = 'bg-purple-600';
                        dayDiv.classList.add(bgColor);
                    }
                    
                    const dayNumber = document.createElement('span');
                    dayNumber.className = 'text-gray-200 font-medium';
                    dayNumber.textContent = i;
                    dayDiv.appendChild(dayNumber);

                    const studyTime = document.createElement('span');
                    studyTime.className = 'text-[10px] text-gray-400 mt-1';
                    if (studyMinutes > 0) {
                        studyTime.textContent = `${studyMinutes}d`;
                    }
                    dayDiv.appendChild(studyTime);
                    calendarContainer.appendChild(dayDiv);
                }
            };
            
            const showDailyDetails = (day) => {
                const today = new Date();
                const dateString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                
                const sessionsForDay = appState.studyRecords.filter(record => record.date === dateString);
                
                dailyDetailsDate.textContent = dateString;
                dailySessionsList.innerHTML = '';

                if (sessionsForDay.length === 0) {
                    dailySessionsList.innerHTML = '<p class="text-gray-400 text-center">Bu güne ait çalışma oturumu bulunamadı.</p>';
                } else {
                    sessionsForDay.forEach(session => {
                        const sessionDiv = document.createElement('div');
                        sessionDiv.className = 'bg-gray-700 rounded-xl p-4 flex justify-between items-center';
                        sessionDiv.innerHTML = `
                            <div>
                                <p class="text-lg font-semibold text-gray-100">${session.subject}</p>
                            </div>
                            <span class="text-lg font-bold text-purple-400">${session.minutes}d</span>
                        `;
                        dailySessionsList.appendChild(sessionDiv);
                    });
                }
                
                dailyDetailsModal.classList.remove('hidden');
                dailyDetailsModal.classList.add('flex');
            };
            
            const showCustomizeModal = () => {
                const minutes = Math.floor(appState.initialDuration / 60);
                minutesInput.value = minutes;
                customizeModal.classList.remove('hidden');
                customizeModal.classList.add('flex');
            };
            
            const saveCustomTimer = () => {
                const newMinutes = parseInt(minutesInput.value);
                if (newMinutes > 0) {
                    const newDuration = newMinutes * 60;
                    if (currentTimerType === 'study') {
                        appState.studyDuration = newDuration;
                        localStorage.setItem('studyDuration', newDuration);
                    } else if (currentTimerType === 'break') {
                        appState.breakDuration = newDuration;
                        localStorage.setItem('breakDuration', newDuration);
                    } else if (currentTimerType === 'longBreak') {
                        appState.longBreakDuration = newDuration;
                        localStorage.setItem('longBreakDuration', newDuration);
                    }
                    resetTimer(newDuration, currentTimerType !== 'study');
                }
                customizeModal.classList.remove('flex');
                customizeModal.classList.add('hidden');
            };
            
            const startNewSession = () => {
                const selectedSubject = customSubjectInput.value || appState.selectedSubject;
                if (!selectedSubject) {
                    showMessage('Lütfen başlamadan önce bir konu seçin.');
                    return;
                }
                closeModal();
                startTimer();
            };

            subjectGrid.addEventListener('click', (e) => {
                const target = e.target.closest('.subject-btn');
                if (target) {
                    document.querySelectorAll('.subject-btn').forEach(btn => btn.classList.remove('selected', 'bg-purple-600', 'ring-2', 'ring-purple-500'));
                    target.classList.add('selected', 'bg-purple-600', 'ring-2', 'ring-purple-500');
                    appState.selectedSubject = target.dataset.subject;
                    customSubjectInput.value = target.dataset.subject; // Yeni eklenen satır
                }
            });

            customSubjectInput.addEventListener('input', () => {
                appState.selectedSubject = null;
                document.querySelectorAll('.subject-btn').forEach(btn => btn.classList.remove('selected', 'bg-purple-600', 'ring-2', 'ring-purple-500'));
            });

            startBtn.addEventListener('click', () => showSaveModal(false));
            pauseResumeBtn.addEventListener('click', togglePauseResume);
            stopSaveBtn.addEventListener('click', stopSessionAndSave);
            
            resetBtn.addEventListener('click', () => {
                resetTimer();
            });

            document.getElementById('set-study').addEventListener('click', () => {
                if (appState.isSessionActive) {
                    showMessage('Lütfen önce mevcut oturumu kaydedin veya sıfırlayın.');
                    return;
                }
                currentTimerType = 'study';
                resetTimer(appState.studyDuration);
            });
            document.getElementById('set-break').addEventListener('click', () => {
                if (appState.isSessionActive) {
                    showMessage('Lütfen önce mevcut oturumu kaydedin veya sıfırlayın.');
                    return;
                }
                currentTimerType = 'break';
                resetTimer(appState.breakDuration, true);
            });
            document.getElementById('set-long-break').addEventListener('click', () => {
                if (appState.isSessionActive) {
                    showMessage('Lütfen önce mevcut oturumu kaydedin veya sıfırlayın.');
                    return;
                }
                currentTimerType = 'longBreak';
                resetTimer(appState.longBreakDuration, true);
            });
            startSessionBtn.addEventListener('click', () => {
                if (modalTitle.textContent === 'Yeni Oturum Başlat') {
                    startNewSession();
                } else {
                    const timeStudied = appState.initialDuration - appState.timeRemaining;
                    if (timeStudied > 0) {
                        saveStudyRecord(timeStudied);
                        closeModal();
                        resetTimer();
                    } else {
                         showMessage('Oturumun kaydedilmesi için 0 dakikadan uzun olması gerekir.');
                         closeModal();
                         resetTimer();
                    }
                }
            });
            cancelSaveBtn.addEventListener('click', () => {
                closeModal();
                // Eğer oturum manuel durdurulmuşsa, modal kapanınca zamanlayıcıyı sıfırla
                if (appState.isSessionActive) {
                     resetTimer();
                }
            });
            closeDailyDetailsBtn.addEventListener('click', () => {
                dailyDetailsModal.classList.remove('flex');
                dailyDetailsModal.classList.add('hidden');
            });
            timerDisplay.addEventListener('click', showCustomizeModal);
            confirmCustomizeBtn.addEventListener('click', saveCustomTimer);
            cancelCustomizeBtn.addEventListener('click', () => {
                customizeModal.classList.remove('flex');
                customizeModal.classList.add('hidden');
            });


            calendarContainer.addEventListener('click', (e) => {
                const dayCell = e.target.closest('.day-cell');
                if (dayCell) {
                    const day = dayCell.dataset.day;
                    if (day) {
                        showDailyDetails(parseInt(day));
                    }
                }
            });

            resetTimer();
            loadRecordsAndRender();
        };
    </script>
</body>
</html>
